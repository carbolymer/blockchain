version: '3.7'
services:
  build:
    image:  blockchain-build
    build:
      context: .
      dockerfile: Dockerfile-build
      target: builder
    volumes:
      - .stack:/home/buildusr/.stack
      - .:/workspace
    entrypoint:
      - /bin/sh
      - -c
      - 'stack --install-ghc clean && (cd blockchain-ui-fe && npm install && ng build --env=prod) && stack-build upx'

  beacon-node:
    image: carbolymer/blockchain-node
    build:
      context: .
      dockerfile: Dockerfile-run
    hostname: beacon-node

  drone-node:
    image: carbolymer/blockchain-node
    build:
      context: .
      dockerfile: Dockerfile-run
    depends_on:
      - beacon-node

  ui:
    image: carbolymer/blockchain-node
    build:
      context: .
      dockerfile: Dockerfile-run
    restart: on-failure
    depends_on:
      - beacon-node
    ports:
      - "8000:8000"
    entrypoint:
      - /usr/local/bin/blockchain-ui-exe
      - "8000"
      - "http://beacon-node:8000/"
      - "/srv"
